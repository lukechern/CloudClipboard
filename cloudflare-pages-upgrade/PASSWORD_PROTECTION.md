# 密码保护功能说明

## 功能概述

CloudClipboard支持通过环境变量设置访问密码，为你的云剪贴板提供基础的访问控制。

## 配置方法

### 1. 设置环境变量

在Cloudflare Pages项目设置中：

1. 进入 **Settings** → **Environment variables**
2. 添加新的环境变量：
   - **Name**: `ACCESS_PASSWORD`
   - **Value**: 你的访问密码（例如：`mySecretPassword123`）
3. 点击 **Save** 保存设置
4. 重新部署项目以使配置生效

### 2. 禁用密码保护

如果要禁用密码保护：

1. 删除 `ACCESS_PASSWORD` 环境变量
2. 或者将其值设置为空
3. 重新部署项目

## 使用体验

### 首次访问

1. 用户访问云剪贴板网址
2. 系统检测到需要密码验证
3. 显示密码输入界面
4. 用户输入正确密码后进入主界面

### 密码记忆

- ✅ 密码验证成功后，会加密保存在浏览器本地存储中
- ✅ 7天内访问无需重复输入密码
- ✅ 用户可以选择是否记住密码
- ✅ 清除浏览器数据会清除保存的密码

### 安全特性

- 🔐 密码在传输过程中通过HTTPS加密
- 🔐 使用JWT签名token，防止伪造（已升级）
- 🔐 智能速率限制，防止暴力破解（新增）
- 🔐 每次API请求都会验证访问权限
- 🔐 密码错误会显示友好的错误提示
- 🔐 自动token过期检查和刷新机制（新增）

## 界面展示

### 密码输入界面

```
🔐 访问验证
请输入访问密码以继续使用云剪贴板

[密码输入框]
☑️ 记住密码（7天内免输入）
[验证访问权限]
```

### 功能特点

- **半透明遮罩**: 主内容被半透明黑色遮罩覆盖
- **居中显示**: 密码输入框居中显示，清晰可见
- **响应式设计**: 支持移动端和桌面端
- **加载状态**: 验证过程中显示加载动画
- **错误提示**: 密码错误时显示红色提示
- **无模糊问题**: 输入框完全清晰，不受任何模糊效果影响

## 技术实现

### 前端认证流程

```javascript
1. 页面加载 → 检查本地存储的认证信息
2. 验证存储的token是否有效
3. 如果无效或不存在 → 显示密码输入界面
4. 用户输入密码 → 发送到服务器验证
5. 验证成功 → 保存token到本地存储
6. 后续API请求携带Authorization头
```

### 后端验证机制

```javascript
1. 检查环境变量ACCESS_PASSWORD是否设置
2. 如果未设置 → 允许访问
3. 如果设置了 → 检查请求头中的Authorization
4. 验证token是否匹配 → 允许或拒绝访问
```

### API端点

- `GET /api/auth`: 检查是否需要密码保护
- `POST /api/auth`: 验证密码
- 所有其他API: 需要携带Authorization头

## 安全考虑

### 当前安全级别

这是一个**基础级别**的访问控制，适用于：
- ✅ 个人使用的云剪贴板
- ✅ 小团队内部使用
- ✅ 防止意外访问
- ✅ 基础的隐私保护

### 不适用场景

不建议用于以下场景：
- ❌ 存储敏感或机密信息
- ❌ 多用户权限管理
- ❌ 企业级安全要求
- ❌ 需要审计日志的场景

### 安全建议

1. **使用强密码**: 建议使用包含字母、数字、特殊字符的复杂密码
2. **定期更换**: 定期更换访问密码
3. **HTTPS访问**: 确保通过HTTPS访问（Cloudflare Pages默认支持）
4. **私密部署**: 不要在公开场合展示你的云剪贴板地址

## 故障排除

### 常见问题

1. **密码设置后仍无验证界面**
   - 检查环境变量是否正确设置
   - 确认项目已重新部署
   - 清除浏览器缓存重试

2. **输入正确密码仍提示错误**
   - 检查密码是否包含特殊字符
   - 确认环境变量值没有多余空格
   - 检查浏览器控制台是否有错误信息

3. **密码记忆功能不工作**
   - 检查浏览器是否允许本地存储
   - 确认没有使用无痕模式
   - 检查浏览器存储空间是否充足

4. **API请求被拒绝**
   - 检查本地存储的token是否过期
   - 清除浏览器数据重新登录
   - 检查网络连接是否正常

### 调试方法

1. **查看浏览器控制台**
   ```javascript
   // 检查认证状态
   console.log(window.authManager.isAuthenticated);
   
   // 查看存储的认证信息
   console.log(localStorage.getItem('cloudclipboard_auth'));
   
   // 手动清除认证信息
   window.authManager.logout();
   ```

2. **检查API响应**
   - 打开浏览器开发者工具
   - 查看Network标签页
   - 检查API请求的响应状态码

## 升级和维护

### 密码更换

1. 在Cloudflare Pages设置中更新 `ACCESS_PASSWORD` 环境变量
2. 重新部署项目
3. 通知用户清除浏览器数据或等待token过期（7天）

### 功能扩展

如果需要更高级的认证功能，可以考虑：
- 多用户支持
- JWT token认证
- OAuth集成
- 访问日志记录
- IP白名单限制

## 总结

密码保护功能为CloudClipboard提供了基础但实用的访问控制，适合个人和小团队使用。通过简单的配置即可启用，用户体验友好，安全性适中。